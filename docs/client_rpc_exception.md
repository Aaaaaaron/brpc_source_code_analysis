[RPC请求发送过程可能会遇到的异常情况](#RPC请求发送过程可能会遇到的异常情况)

[brpc对各类发送异常的处理方式](#brpc对各类发送异常的处理方式)

## RPC请求发送过程可能会遇到的异常情况
在一次RPC过程中（假设一个客户端fd与一个服务端fd原先已正常建立TCP长连接），客户端向服务器发送请求时可能会遇到如下各类异常：

1. 服务器限流

   服务器接收请求的队列的长度超出阈值，此时服务器不能再负责处理新到的请求，否则服务器可能压力过大而崩溃。

2. 服务器正在退出

   服务器正在退出服务，此时服务器进程虽然存活，但不能响应客户端的请求。

3. 服务器进程正常关闭fd

   服务器进程正常关闭fd包括三种情况：
   
   - 服务器进程主动调用close关闭fd；
   
   - 服务器进程主动调用exit；
   
   - 在shell下kill或ctrl+c杀掉服务器进程。
   
   以上三种情况都会正常关闭服务端fd，TCP连接上会将FIN发给客户端，客户端的epoll会通知客户端的fd可读，触发的事件是EPOLLIN和EPOLLRDHUP，客户端应用层对fd执行read调用的返回值是0。

4. 机器断电导致的服务器进程异常关闭

   服务器进程所在的机器可能在如下时刻断电：
   
   - 客户端发送数据过程中服务器机器断电
   
     这里的客户端发送数据指的是客户端机器内核TCP/IP协议栈向服务器发送数据，客户端应用层进程只是将数据写入fd的内核inode发送缓存，操作系统内核的TCP/IP协议栈负责将inode发送缓存里的数据真正发送到网络上。如果服务器机器断电而客户端没有任何动作，则客户端不会被告知对端异常，只有当客户端的TCP/IP协议栈执行发送数据的动作时，由于滑动窗口无法滑动、无法收到已发数据的Ack等原因，协议栈会感知到对端异常，epoll会触发EPOLLERR事件通知应用层TCP连接已异常断开（此处的逻辑需要进一步查阅Linux内核协议栈代码来证实）。
   
   - 客户端已将数据发到网络上，服务器进程接到请求数据前机器断电
   
     客户端在超时时间内无法接收到响应，走超时处理的逻辑。
   
   - 服务器进程处理请求过程中断电
   
     同上，客户端会判断超时。

5. 网络断线

   断线包括网线断开、客户端与服务器间的路由器故障等，发生的场景有：
   
   - 客户端发送数据时网络断线
   
     与发送数据时服务器断电的逻辑一致，内核在发送数据时检测到TCP连接异常，epoll触发EPOLLERR事件通知应用层TCP连接异常（需进一步查阅Linux内核协议栈代码证实）。
   
   - 客户端发送请求成功，请求数据在网络上传输时断线，服务器未收到请求
   
     客户端在超时时间内无法收到响应，走超时处理的逻辑。服务器内核协议栈没有读写动作，不会得知此时TCP连接异常。
   
   - 客户端发送请求成功，服务器处理请求过程中网络断线
   
     客户端在超时时间内无法收到响应，走超时处理的逻辑。服务器内核协议栈发送响应数据过程中检测到TCP连接异常。
   
   - 客户端发送请求成功，服务器处理请求后发送响应成功，响应数据在网络上传输时断线，客户端未收到响应
   
     客户端走超时处理的逻辑。服务器内核协议栈接下来没有读写动作，不会得知此时TCP连接异常。
   
   - 由于断线，服务器可能只接收到请求数据的一个片段，或者客户端只接收到响应数据的一个片段
   
     按照非法数据处理。

下面阐述brpc是如何处理发送RPC请求过程中可能出现的上述各种异常的。

5、一次成功的response处理完，Id结构就被销毁，处理其他重试返回的response时的bthread_id_lock操作直接返回失败
## brpc对各类发送异常的处理方式

